<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 user-feedback MCP Tools - Enhanced</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA2xJREFUWEfFl11oXFUUhb99bjKTSZqYtE1sNUqLFkSQolQEH/xBK4ggCj4oQsEHfRAR8UH0QfBBEAQfBEERRPBBRBB88EEQQYqIqFgVW6xarTY/TZO0zUwyk5k795zr3jOTSWYmmbmTFhI4D/fes/faa6+99rrC/3yJ/zn/iwF+3PoMm9ufp6XxGZqcY0YZZmQPE2qI78f38N3oXv4VAFW20i/e5oH2VwFoVJIG5WhQjriCuHKIgo8O3uT9kb0kVJL2xDBbW16kI9ZLs3I0KMuMsvwxu4fPJj7mx8yP1HLnqgA6xOu83bmNu5ubERStStOqNB3K0KEcMWXwFCTVEP+M7+PT8Y+YUgO0RXvZ3PIinbFe2pWjRVkaVYIx1c+X6U/5ZuojTqmjVAJUCVAtg33tzxGPdNBWCtyB1CqAjmVPgSkssyrBnErwS/p7vpj8lJNqgJgYYVPzi9zd3EWXcpW1UYlsuwU8u/VdNrW8SFdTP0oJAAqhtQIXS8kThkk1wC/p7/ly8lPOqAEalcNXwpQa4IvJT/kz80PlRKgG0NP0BPe0PElH02NIpQsAWqsqgAXggAk1yLepz/k682tgQ3FPR+Q2ehqfpb+pm6U2lEuAXrGVB9peoKv5UaRWaNMKYEr1U1pEqx4y6iiJWB8nmCQ5f4Tfs7/hy2FalKVFGWLKl9ZMqiG+Tvd5BQsgd4pd/m7aEu20KYtWimklaFCAUlAL4L9juz+rz9AdH6bJ/hP89uzj59lvcZSrNlXlAWjQV2/zo9y78T3aEh0F4wEUBWilmHUSgPnz43qQ/qaTdDaeoiXeRkTHmFVR0irCtIow4RQp+CX9Hd+kv2ZGD1VdBZUAGg1v3vY+d3VvJx65hQZbWAu+sow5SdKWJrfS4Ssg7QyJSB8Tk738NfMTV/x+Js0Es85U3FwVgNV39/k72bjtI1rjG9BOAhZaVAJP+/hOBRJBAvxAhAtniKUG+XP6OGnvShDsZWe0CkBvsJu7PviQ9niXB+AtCQDWAEirccbMIMfOH+aSfyGoqqoCxP7tbh596yfaWjuYzY0zZM9z3AxxYuY4Y3a0ahlWA1i7YRO9uz+gvaOXhWySMTPEkBkqa7kWQOfWbbTt/ISO7oeCsVP/HWDVLVipYqsC/AvW2I8wIl3IxQAAAABJRU5ErkJggg==">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Socket.IO Client (served from static folder) -->
    <script src="/socket.io.min.js"></script>
    <!-- Navbar Component -->
    <link rel="stylesheet" href="/components/navbar.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Unified Navigation Bar (injected by navbar.js) -->
    <!-- 連接狀態指示器 + 版本號 + 自動回覆計時器 (!不准刪除)-->
    <div class="connection-status" id="connectionStatus">
        <span class="status-dot"></span>
        <span class="status-text">連接中...</span>
        <!-- 版本顯示 -->
        <span id="version-display" class="version-display" title="當前版本">v--</span>
        <!-- 自動回覆計時器（與連接指示器一起） -->
        <div id="auto-reply-timer" class="auto-reply-timer" title="點擊暫停 / 再次點擊繼續自動回覆倒數" aria-label="自動回覆倒數，點擊可暫停或繼續">
            / ⏱️自動回覆倒數: <span id="auto-reply-seconds">--</span>s
        </div>
    </div>

    <!-- 主容器（三欄式佈局） -->
    <div class="feedback-container">
        <!-- 左側：AI 訊息顯示區 (30%) -->
        <div class="panel ai-panel">
            <div class="panel-header">
                <h3 class="panel-title">
                    <span class="icon">🤖</span>
                    AI 工作匯報
                </h3>
                <span id="projectInfo" class="project-info"></span>
            </div>
            <div class="panel-content">
                <div id="aiMessageDisplay" class="ai-message-display">
                    <div class="placeholder">
                        <span class="icon">⏳</span>
                        <p>等待 AI 工作匯報...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中間：使用者互動區 (40%) -->
        <div class="panel user-panel">
            <!-- 上方：文字回應輸入區 (60%) -->
            <div class="input-section">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <span class="icon">💬</span>
                        您的回應
                    </h3>
                    <!-- 關閉頁面倒數計時器（從 MCP_DIALOG_TIMEOUT 讀取秒數，倒數到 0 自動關閉） -->
                    <div id="close-cd" class="close-cd" style="display: none; margin-right:8px; align-self:center;">60</div>
                    <button id="aiReplyBtn" class="btn btn-secondary" title="使用 AI 生成回應">
                        <span class="icon">✨</span>
                        AI 回覆
                    </button>
                    <button id="submitBtn" class="btn btn-primary" title="提交您的回應" style="margin-left:8px;">
                        <span class="icon">📤</span>
                        提交回應
                    </button>
                </div>
                <div class="panel-content">
                    <textarea 
                        id="feedbackText" 
                        class="feedback-input" 
                        placeholder="在此輸入您的回應...&#10;&#10;提示：&#10;- 按 Ctrl+Enter 快速提交&#10;- 可以留空直接提交（跳過）&#10;- 點擊「AI 回覆」按鈕生成建議回應"
                    ></textarea>
                    <div class="input-footer">
                        <div class="char-count" id="charCount">0 字元</div>
                    </div>
                </div>
            </div>

            <!-- 下方：圖片上傳/貼上區 (40%) -->
            <div class="image-section">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <span class="icon">🖼️</span>
                        圖片 <span id="imageCount" class="badge">0</span>
                    </h3>
                    <button id="clearImagesBtn" class="btn btn-ghost" title="清除所有圖片">
                        <span class="icon">🗑️</span>
                    </button>
                </div>
                <div class="panel-content">
                    <div id="imageDropZone" class="image-drop-zone">
                        <div class="drop-zone-content">
                            <span class="icon">📁</span>
                            <p>拖放圖片至此，或點擊選擇文件</p>
                            <p class="hint">支援貼上圖片 (Ctrl+V)</p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                    </div>
                    <div id="imagePreviewContainer" class="image-preview-container"></div>
                </div>
            </div>
        </div>

        <!-- 右側：提示詞管理區 (30%) -->
        <div class="panel prompt-panel">
            <div class="panel-header">
                <h3 class="panel-title">
                    <span class="icon">📝</span>
                    提示詞
                </h3>

            </div>
            <div class="panel-content">
                <!-- 搜尋框 -->
                <div class="search-box">
                    <input type="text" id="promptSearch" class="search-input" placeholder="搜尋提示詞...">
                </div>

                <!-- 提示詞列表 -->
                <div id="promptList" class="prompt-list">
                    <div class="placeholder">
                        <span class="icon">📋</span>
                        <p>尚無提示詞</p>
                        <button id="addPromptBtn" class="btn btn-secondary btn-sm">新增提示詞</button>
                    </div>
                </div>

                <!-- 新增提示詞按鈕 -->
                <div class="panel-footer">
                    <button id="addPromptBtnFooter" class="btn btn-primary btn-block">
                        <span class="icon">➕</span>
                        新增提示詞
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 自動回覆警告提示 -->
    <div id="autoReplyWarning" class="auto-reply-warning" style="display: none;">
        <div class="warning-content">
            <span class="icon">⏰</span>
            <span id="warningText">系統將在 60 秒後自動生成回應</span>
            <button id="cancelAutoReply" class="btn btn-ghost btn-sm">取消</button>
        </div>
    </div>    

    <!-- AI 設定彈窗 -->
    <div id="aiSettingsModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">⚙️</span>
                    AI 設定
                </h2>
                <button class="modal-close" id="closeAiSettings">
                    <span class="icon">✖️</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="aiSettingsForm">
                    <div class="form-group">
                        <label for="apiUrl">API URL</label>
                        <input type="text" id="apiUrl" class="form-control" placeholder="https://generativelanguage.googleapis.com/v1beta">
                    </div>

                    <div class="form-group">
                        <label for="model">模型名稱</label>
                        <input type="text" id="model" class="form-control" placeholder="gemini-2.0-flash-exp">
                    </div>

                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <div class="input-group">
                            <input type="password" id="apiKey" class="form-control" placeholder="輸入您的 API Key">
                            <button type="button" id="toggleApiKey" class="btn btn-ghost">
                                <span class="icon">👁️</span>
                            </button>
                        </div>
                        <small class="form-hint">API Key 將被加密儲存</small>
                    </div>

                    <div class="form-group">
                        <label for="systemPrompt">系統提示詞</label>
                        <textarea id="systemPrompt" class="form-control" rows="6" placeholder="設定 AI 的行為和回應風格..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="mcpToolsPrompt">MCP 工具提示詞</label>
                        <textarea id="mcpToolsPrompt" class="form-control" rows="8" placeholder="設定 MCP 工具的使用說明，會在 AI 回覆時附加到提示詞中..."></textarea>
                        <small class="form-hint">定義 AI 如何使用 MCP 工具收集專案資訊。{project_name} 和 {project_path} 會被替換為實際值。</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="temperature">Temperature</label>
                            <input type="number" id="temperature" class="form-control" min="0" max="2" step="0.1" value="0.7">
                        </div>

                        <div class="form-group">
                            <label for="maxTokens">Max Tokens</label>
                            <input type="number" id="maxTokens" class="form-control" min="100" max="4000" step="100" value="1000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="autoReplyTimerSeconds">自動 AI 回覆時間（秒）</label>
                        <input type="number" id="autoReplyTimerSeconds" class="form-control" min="30" max="600" step="10" value="300" placeholder="300">
                        <small class="form-hint">頁面載入後經過此秒數將自動生成 AI 回覆（30-600 秒，預設 300 秒）</small>
                    </div>

                    <div class="form-group">
                        <label for="maxToolRounds">AI 交談次數上限</label>
                        <input type="number" id="maxToolRounds" class="form-control" min="1" max="20" step="1" value="5" placeholder="5">
                        <small class="form-hint">AI 使用 MCP 工具的最大回合數（1-20 次，預設 5 次）</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="debugMode">
                            <span class="checkbox-text">🔧 Debug 模式</span>
                        </label>
                        <small class="form-hint">開啟後 Streaming Panel 不會自動關閉，需手動點擊關閉</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="testApiKey" class="btn btn-secondary">
                    <span class="icon">🔍</span>
                    測試連接
                </button>
                <button type="button" id="editPromptsFromSettings" class="btn btn-secondary">
                    <span class="icon">📝</span>
                    編輯提示詞
                </button>
                <button type="button" id="saveAiSettings" class="btn btn-primary">
                    <span class="icon">💾</span>
                    儲存設定
                </button>
            </div>
        </div>
    </div>

    <!-- MCP Servers 彈窗 -->
    <div id="mcpServersModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">🔌</span>
                    MCP Servers
                </h2>
                <button class="modal-close" id="closeMcpServers">
                    <span class="icon">✖️</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- MCP Server 列表 -->
                <div id="mcpServerList" class="mcp-server-list">
                    <div class="placeholder">
                        <span class="icon">🔌</span>
                        <p>尚無 MCP Server</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="connectAllMcpServers" class="btn btn-secondary">
                    <span class="icon">🔗</span>
                    全部連接
                </button>
                <button type="button" id="disconnectAllMcpServers" class="btn btn-secondary">
                    <span class="icon">🔌</span>
                    全部斷開
                </button>
                <button type="button" id="addMcpServer" class="btn btn-primary">
                    <span class="icon">➕</span>
                    新增 Server
                </button>
            </div>
        </div>
    </div>

    <!-- 新增/編輯 MCP Server 彈窗 -->
    <div id="mcpServerEditModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">🔌</span>
                    <span id="mcpServerEditTitle">新增 MCP Server</span>
                </h2>
                <button class="modal-close" id="closeMcpServerEdit">
                    <span class="icon">✖️</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="mcpServerForm">
                    <input type="hidden" id="mcpServerId">
                    <div class="form-group">
                        <label for="mcpServerName">名稱</label>
                        <input type="text" id="mcpServerName" class="form-control" placeholder="MCP Server 名稱" required>
                    </div>

                    <div class="form-group">
                        <label for="mcpServerTransport">傳輸方式</label>
                        <select id="mcpServerTransport" class="form-control">
                            <option value="stdio">stdio (本地程序)</option>
                            <option value="sse">SSE (Server-Sent Events)</option>
                            <option value="streamable-http">Streamable HTTP</option>
                        </select>
                    </div>

                    <!-- stdio 設定 -->
                    <div id="stdioSettings" class="transport-settings">
                        <div class="form-group">
                            <label for="mcpServerCommand">命令</label>
                            <input type="text" id="mcpServerCommand" class="form-control" placeholder="例如: npx 或 node">
                        </div>
                        <div class="form-group">
                            <label for="mcpServerArgs">參數 (每行一個)</label>
                            <textarea id="mcpServerArgs" class="form-control" rows="3" placeholder="例如:\n-y\n@anthropic/mcp-server-time"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="mcpServerEnv">環境變數 (KEY=VALUE，每行一個)</label>
                            <textarea id="mcpServerEnv" class="form-control" rows="2" placeholder="例如:\nAPI_KEY=xxx"></textarea>
                        </div>
                    </div>

                    <!-- SSE/HTTP 設定 -->
                    <div id="httpSettings" class="transport-settings" style="display: none;">
                        <div class="form-group">
                            <label for="mcpServerUrl">伺服器 URL</label>
                            <input type="url" id="mcpServerUrl" class="form-control" placeholder="http://localhost:3000/mcp">
                        </div>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="mcpServerEnabled" class="form-check-input" checked>
                        <label for="mcpServerEnabled" class="form-check-label">
                            <span class="icon">✅</span>
                            啟用此 Server
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelMcpServer" class="btn btn-secondary">取消</button>
                <button type="button" id="saveMcpServer" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>

    <!-- 新增/編輯提示詞彈窗 -->
    <div id="promptModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">📝</span>
                    <span id="promptModalTitle">新增提示詞</span>
                </h2>
                <button class="modal-close" id="closePromptModal">
                    <span class="icon">✖️</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="promptForm">
                    <input type="hidden" id="promptId">
                    <div class="form-group">
                        <label for="promptTitle">標題</label>
                        <input type="text" id="promptTitle" class="form-control" placeholder="提示詞標題" required>
                    </div>

                    <div class="form-group">
                        <label for="promptContent">內容</label>
                        <textarea id="promptContent" class="form-control" rows="6" placeholder="提示詞內容..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="promptCategory">分類（選填）</label>
                        <input type="text" id="promptCategory" class="form-control" placeholder="例如：問候、總結、建議">
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="promptIsPinned" class="form-check-input">
                        <label for="promptIsPinned" class="form-check-label">
                            <span class="icon">📌</span>
                            釘選此提示詞（啟動時自動載入）
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelPrompt" class="btn btn-secondary">取消</button>
                <button type="button" id="savePrompt" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- AI 回覆 Streaming 面板 -->
    <div id="aiStreamingPanel" class="ai-streaming-panel" style="display: none;">
        <div class="streaming-content">
            <div class="streaming-header">
                <div class="streaming-title">
                    <span class="icon">🤖</span>
                    <span id="streamingTitle">AI 回覆中...</span>
                </div>
                <div class="streaming-status">
                    <span class="status-indicator" id="streamingStatusIndicator"></span>
                    <span id="streamingStatus">準備中</span>
                </div>
            </div>
            <div class="streaming-body">
                <div class="streaming-progress" id="streamingProgress">
                    <!-- 進度項目會動態添加 -->
                </div>
                <div class="streaming-output" id="streamingOutput">
                    <!-- AI 輸出會在這裡顯示 -->
                </div>
            </div>
            <div class="streaming-footer">
                <button type="button" id="cancelStreaming" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <!-- 載入中覆蓋層（簡單操作用） -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p id="loadingText">處理中...</p>
        </div>
    </div>

    <!-- 通用彈窗（用於提示/警示） -->
    <div id="alertModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">⚠️</span>
                    <span id="alertModalTitle">提醒</span>
                </h2>
            </div>
            <div class="modal-body">
                <p id="alertModalBody">訊息內容</p>
            </div>
            <div class="modal-footer">
                <button id="alertModalOk" class="btn btn-primary">確定</button>
            </div>
        </div>
    </div>

    <!-- 日誌檢視器彈窗 -->
    <div id="logViewerModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">📋</span>
                    系統日誌
                </h2>
                <button class="modal-close" id="closeLogViewer">
                    <span class="icon">✖️</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 搜尋和篩選區（緊湊版） -->
                <div class="log-filter-bar">
                    <input type="text" id="logSearch" class="form-control" placeholder="搜尋日誌內容...">
                    <select id="logLevelFilter" class="form-control log-select-sm">
                        <option value="">全部級別</option>
                        <option value="error">Error</option>
                        <option value="warn">Warn</option>
                        <option value="info">Info</option>
                        <option value="debug">Debug</option>
                    </select>
                    <select id="logSourceFilter" class="form-control log-select-sm">
                        <option value="">全部來源</option>
                    </select>
                    <input type="date" id="logStartDate" class="form-control log-date-sm" title="開始日期">
                    <input type="date" id="logEndDate" class="form-control log-date-sm" title="結束日期">
                    <button id="logSearchBtn" class="btn btn-secondary btn-sm" title="搜尋">🔍</button>
                    <button id="logRefreshBtn" class="btn btn-ghost btn-sm" title="重新整理">🔄</button>
                </div>

                <!-- 日誌列表 -->
                <div id="logEntriesContainer" class="log-entries-container">
                    <div class="placeholder">
                        <span class="icon">📭</span>
                        <p>尚無日誌記錄</p>
                    </div>
                </div>

                <!-- 分頁控制 -->
                <div class="log-pagination">
                    <button id="logPrevPage" class="btn btn-ghost btn-sm" disabled>◀ 上一頁</button>
                    <span id="logPageInfo" class="log-page-info">1 / 1</span>
                    <button id="logNextPage" class="btn btn-ghost btn-sm" disabled>下一頁 ▶</button>
                    <button type="button" id="clearOldLogs" class="btn btn-ghost btn-sm" title="清除7天前日誌">🗑️</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自動回覆確認模態框 -->
    <div id="autoReplyConfirmModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">⏱️</span>
                    <span>自動回覆確認</span>
                </h2>
                <button class="modal-close" id="closeAutoReplyConfirm"></button>
            </div>
            <div class="modal-body">
                <p>AI 將在 <strong><span id="autoReplyCountdown">10</span> 秒</strong>後自動發送回覆</p>
                <div id="autoReplyPreview" class="reply-preview" style="margin-top: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;"></div>
            </div>
            <div class="modal-footer">
                <button id="cancelAutoReplyConfirm" class="btn btn-secondary">取消</button>
                <button id="confirmAutoReplySubmit" class="btn btn-primary">確認提交</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/components/navbar.js"></script>
    <script type="module" src="app.js"></script>
</body>
</html>
