<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 user-feedback MCP Tools - Enhanced</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 連接狀態指示器 + 自動回覆計時器 -->
    <div class="connection-status" id="connectionStatus">
        <span class="status-dot"></span>
        <span class="status-text">連接中...</span>
        <!-- 自動回覆計時器（與連接指示器一起） -->
        <div id="auto-reply-timer" class="auto-reply-timer">
            / ⏱️自動回覆倒數: <span id="auto-reply-seconds">--</span>s
        </div>
    </div>

    <!-- 主容器（三欄式佈局） -->
    <div class="feedback-container">
        <!-- 左側：AI 訊息顯示區 (30%) -->
        <div class="panel ai-panel">
            <div class="panel-header">
                <h3 class="panel-title">
                    <span class="icon">🤖</span>
                    AI 工作匯報
                </h3>
            </div>
            <div class="panel-content">
                <div id="aiMessageDisplay" class="ai-message-display">
                    <div class="placeholder">
                        <span class="icon">⏳</span>
                        <p>等待 AI 工作匯報...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中間：使用者互動區 (40%) -->
        <div class="panel user-panel">
            <!-- 上方：文字回應輸入區 (60%) -->
            <div class="input-section">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <span class="icon">💬</span>
                        您的回應
                    </h3>
                    <!-- 關閉頁面倒數計時器（從 MCP_DIALOG_TIMEOUT 讀取秒數，倒數到 0 自動關閉） -->
                    <div id="close-cd" class="close-cd" style="display: none; margin-right:8px; align-self:center;">60</div>
                    <button id="aiReplyBtn" class="btn btn-secondary" title="使用 AI 生成回應">
                        <span class="icon">✨</span>
                        AI 回覆
                    </button>
                    <button id="submitBtn" class="btn btn-primary" title="提交您的回應" style="margin-left:8px;">
                        <span class="icon">📤</span>
                        提交回應
                    </button>
                </div>
                <div class="panel-content">
                    <textarea 
                        id="feedbackText" 
                        class="feedback-input" 
                        placeholder="在此輸入您的回應...&#10;&#10;提示：&#10;- 按 Ctrl+Enter 快速提交&#10;- 可以留空直接提交（跳過）&#10;- 點擊「AI 回覆」按鈕生成建議回應"
                    ></textarea>
                    <div class="input-footer">
                        <div class="char-count" id="charCount">0 字元</div>
                    </div>
                </div>
            </div>

            <!-- 下方：圖片上傳/貼上區 (40%) -->
            <div class="image-section">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <span class="icon">🖼️</span>
                        圖片 <span id="imageCount" class="badge">0</span>
                    </h3>
                    <button id="clearImagesBtn" class="btn btn-ghost" title="清除所有圖片">
                        <span class="icon">🗑️</span>
                    </button>
                </div>
                <div class="panel-content">
                    <div id="imageDropZone" class="image-drop-zone">
                        <div class="drop-zone-content">
                            <span class="icon">📁</span>
                            <p>拖放圖片至此，或點擊選擇文件</p>
                            <p class="hint">支援貼上圖片 (Ctrl+V)</p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                    </div>
                    <div id="imagePreviewContainer" class="image-preview-container"></div>
                </div>
            </div>
        </div>

        <!-- 右側：提示詞管理區 (30%) -->
        <div class="panel prompt-panel">
            <div class="panel-header">
                <h3 class="panel-title">
                    <span class="icon">📝</span>
                    提示詞
                </h3>
                <button id="aiSettingsBtn" class="btn btn-ghost" title="AI 設定">
                    <span class="icon">⚙️</span>
                </button>
            </div>
            <div class="panel-content">
                <!-- 搜尋框 -->
                <div class="search-box">
                    <input type="text" id="promptSearch" class="search-input" placeholder="搜尋提示詞...">
                </div>

                <!-- 提示詞列表 -->
                <div id="promptList" class="prompt-list">
                    <div class="placeholder">
                        <span class="icon">📋</span>
                        <p>尚無提示詞</p>
                        <button id="addPromptBtn" class="btn btn-secondary btn-sm">新增提示詞</button>
                    </div>
                </div>

                <!-- 新增提示詞按鈕 -->
                <div class="panel-footer">
                    <button id="addPromptBtnFooter" class="btn btn-primary btn-block">
                        <span class="icon">➕</span>
                        新增提示詞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自動回覆警告提示 -->
    <div id="autoReplyWarning" class="auto-reply-warning" style="display: none;">
        <div class="warning-content">
            <span class="icon">⏰</span>
            <span id="warningText">系統將在 60 秒後自動生成回應</span>
            <button id="cancelAutoReply" class="btn btn-ghost btn-sm">取消</button>
        </div>
    </div>

    <!-- AI 設定彈窗 -->
    <div id="aiSettingsModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">⚙️</span>
                    AI 設定
                </h2>
                <button class="modal-close" id="closeAiSettings">
                    <span class="icon">✖️</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="aiSettingsForm">
                    <div class="form-group">
                        <label for="apiUrl">API URL</label>
                        <input type="text" id="apiUrl" class="form-control" placeholder="https://generativelanguage.googleapis.com/v1beta">
                    </div>

                    <div class="form-group">
                        <label for="model">模型名稱</label>
                        <input type="text" id="model" class="form-control" placeholder="gemini-2.0-flash-exp">
                    </div>

                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <div class="input-group">
                            <input type="password" id="apiKey" class="form-control" placeholder="輸入您的 API Key">
                            <button type="button" id="toggleApiKey" class="btn btn-ghost">
                                <span class="icon">👁️</span>
                            </button>
                        </div>
                        <small class="form-hint">API Key 將被加密儲存</small>
                    </div>

                    <div class="form-group">
                        <label for="systemPrompt">系統提示詞</label>
                        <textarea id="systemPrompt" class="form-control" rows="6" placeholder="設定 AI 的行為和回應風格..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="temperature">Temperature</label>
                            <input type="number" id="temperature" class="form-control" min="0" max="2" step="0.1" value="0.7">
                        </div>

                        <div class="form-group">
                            <label for="maxTokens">Max Tokens</label>
                            <input type="number" id="maxTokens" class="form-control" min="100" max="4000" step="100" value="1000">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="testApiKey" class="btn btn-secondary">
                    <span class="icon">🔍</span>
                    測試連接
                </button>
                <button type="button" id="editPromptsFromSettings" class="btn btn-secondary">
                    <span class="icon">📝</span>
                    編輯提示詞
                </button>
                <button type="button" id="saveAiSettings" class="btn btn-primary">
                    <span class="icon">💾</span>
                    儲存設定
                </button>
            </div>
        </div>
    </div>

    <!-- 新增/編輯提示詞彈窗 -->
    <div id="promptModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">📝</span>
                    <span id="promptModalTitle">新增提示詞</span>
                </h2>
                <button class="modal-close" id="closePromptModal">
                    <span class="icon">✖️</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="promptForm">
                    <input type="hidden" id="promptId">
                    <div class="form-group">
                        <label for="promptTitle">標題</label>
                        <input type="text" id="promptTitle" class="form-control" placeholder="提示詞標題" required>
                    </div>

                    <div class="form-group">
                        <label for="promptContent">內容</label>
                        <textarea id="promptContent" class="form-control" rows="6" placeholder="提示詞內容..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="promptCategory">分類（選填）</label>
                        <input type="text" id="promptCategory" class="form-control" placeholder="例如：問候、總結、建議">
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="promptIsPinned" class="form-check-input">
                        <label for="promptIsPinned" class="form-check-label">
                            <span class="icon">📌</span>
                            釘選此提示詞（啟動時自動載入）
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelPrompt" class="btn btn-secondary">取消</button>
                <button type="button" id="savePrompt" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- 載入中覆蓋層 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p id="loadingText">處理中...</p>
        </div>
    </div>

    <!-- 通用彈窗（用於提示/警示） -->
    <div id="alertModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">⚠️</span>
                    <span id="alertModalTitle">提醒</span>
                </h2>
            </div>
            <div class="modal-body">
                <p id="alertModalBody">訊息內容</p>
            </div>
            <div class="modal-footer">
                <button id="alertModalOk" class="btn btn-primary">確定</button>
            </div>
        </div>
    </div>

    <!-- 自動回覆確認模態框 -->
    <div id="autoReplyConfirmModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="icon">⏱️</span>
                    <span>自動回覆確認</span>
                </h2>
                <button class="modal-close" id="closeAutoReplyConfirm"></button>
            </div>
            <div class="modal-body">
                <p>AI 將在 <strong><span id="autoReplyCountdown">10</span> 秒</strong>後自動發送回覆</p>
                <div id="autoReplyPreview" class="reply-preview" style="margin-top: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;"></div>
            </div>
            <div class="modal-footer">
                <button id="cancelAutoReplyConfirm" class="btn btn-secondary">取消</button>
                <button id="confirmAutoReplySubmit" class="btn btn-primary">確認提交</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
