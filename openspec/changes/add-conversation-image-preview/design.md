# Design: add-conversation-image-preview

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Conversation Panel                            â”‚
â”‚                 (conversation-panel.js)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Conversation Entry                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Entry Header (summary)                             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ“¤ æç¤ºè© | 10:30:45 | API                         â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Entry Body                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Entry Content (text)                         â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  "è«‹å¹«æˆ‘åˆ†æé€™å€‹æˆªåœ–..."                      â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Entry Images (NEW)                           â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                     â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ ğŸ–¼ï¸ â”‚ â”‚ ğŸ–¼ï¸ â”‚ â”‚ ğŸ–¼ï¸ â”‚  [+2]               â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Click
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Image Lightbox (NEW)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                     [âœ•]   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   [â—€]          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           [â–¶]     â”‚  â”‚
â”‚  â”‚                â”‚                     â”‚                    â”‚  â”‚
â”‚  â”‚                â”‚    Full Image       â”‚                    â”‚  â”‚
â”‚  â”‚                â”‚                     â”‚                    â”‚  â”‚
â”‚  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚                      1 / 3                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Design

### 1. Entry Images Container

```javascript
// conversation-panel.js - createConversationEntry æ“´å±•
function renderEntryImages(images, maxThumbnails = 4) {
  if (!images || images.length === 0) return '';
  
  const displayImages = images.slice(0, maxThumbnails);
  const remainingCount = images.length - maxThumbnails;
  
  const thumbnails = displayImages.map((img, index) => `
    <div class="entry-image-thumb" 
         data-index="${index}" 
         onclick="openImageLightbox(${index}, this)">
      <img src="data:${img.type};base64,${img.data}" 
           alt="Image ${index + 1}" 
           loading="lazy">
    </div>
  `).join('');
  
  const moreIndicator = remainingCount > 0 
    ? `<div class="entry-image-more">+${remainingCount}</div>`
    : '';
  
  return `
    <div class="entry-images" data-images='${JSON.stringify(images)}'>
      ${thumbnails}
      ${moreIndicator}
    </div>
  `;
}
```

### 2. Image Lightbox Component

```javascript
// image-lightbox.js (æ–°æ¨¡çµ„)
export const ImageLightbox = {
  currentImages: [],
  currentIndex: 0,
  
  open(images, startIndex = 0) {
    this.currentImages = images;
    this.currentIndex = startIndex;
    this.render();
    this.show();
    this.bindKeyboard();
  },
  
  close() {
    this.hide();
    this.unbindKeyboard();
  },
  
  next() {
    if (this.currentIndex < this.currentImages.length - 1) {
      this.currentIndex++;
      this.updateImage();
    }
  },
  
  prev() {
    if (this.currentIndex > 0) {
      this.currentIndex--;
      this.updateImage();
    }
  },
  
  render() {
    // å‰µå»º Lightbox DOM çµæ§‹
  },
  
  updateImage() {
    // æ›´æ–°é¡¯ç¤ºçš„åœ–ç‰‡
  },
  
  bindKeyboard() {
    // ESC: é—œé–‰, å·¦å³ç®­é ­: åˆ‡æ›
  }
};
```

### 3. CSS Architecture

```css
/* Entry Images å®¹å™¨ */
.entry-images {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-sm);
  padding: var(--spacing-sm);
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

/* ç¸®ç•¥åœ– */
.entry-image-thumb {
  width: 60px;
  height: 60px;
  border-radius: var(--radius-xs);
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.entry-image-thumb:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.entry-image-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* æ›´å¤šåœ–ç‰‡æŒ‡ç¤ºå™¨ */
.entry-image-more {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-xs);
  color: var(--text-secondary);
  font-weight: 600;
  cursor: pointer;
}

/* Lightbox è¦†è“‹å±¤ */
.image-lightbox {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(4px);
}

.image-lightbox.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Lightbox ä¸»é«” */
.lightbox-container {
  position: relative;
  max-width: 90vw;
  max-height: 90vh;
}

.lightbox-image {
  max-width: 100%;
  max-height: 85vh;
  object-fit: contain;
}

/* Lightbox æ§åˆ¶é … */
.lightbox-close {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255,255,255,0.1);
  color: white;
  border-radius: 50%;
  cursor: pointer;
  font-size: 20px;
}

.lightbox-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 50px;
  height: 50px;
  border: none;
  background: rgba(255,255,255,0.1);
  color: white;
  border-radius: 50%;
  cursor: pointer;
  font-size: 24px;
}

.lightbox-nav.prev { left: 20px; }
.lightbox-nav.next { right: 20px; }

.lightbox-counter {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 14px;
}
```

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Action                               â”‚
â”‚                     (æäº¤å¸¶åœ–ç‰‡çš„å›é¥‹)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      feedback-handler.js                         â”‚
â”‚  - æ§‹å»º feedbackData åŒ…å« images[]                               â”‚
â”‚  - èª¿ç”¨ addConversationEntry('prompt', text, { images })         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    conversation-panel.js                         â”‚
â”‚  - createConversationEntry() æ¥æ”¶ options.images                 â”‚
â”‚  - èª¿ç”¨ renderEntryImages(images) æ¸²æŸ“ç¸®ç•¥åœ–                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DOM Update                               â”‚
â”‚  - å°è©±æ¢ç›®é¡¯ç¤ºæ–‡å­—å…§å®¹                                          â”‚
â”‚  - å°è©±æ¢ç›®é¡¯ç¤ºåœ–ç‰‡ç¸®ç•¥åœ–                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ Click thumbnail
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      image-lightbox.js                           â”‚
â”‚  - è®€å–åœ–ç‰‡æ•¸æ“š                                                  â”‚
â”‚  - é–‹å•Ÿ Lightbox é¡¯ç¤ºå®Œæ•´åœ–ç‰‡                                    â”‚
â”‚  - æ”¯æ´å·¦å³åˆ‡æ›                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Changes

### createConversationEntry å‡½æ•¸æ“´å±•

```javascript
// Before
createConversationEntry(type, content, options = {})
// options: { title, collapsed, timestamp, badge }

// After
createConversationEntry(type, content, options = {})
// options: { title, collapsed, timestamp, badge, images }
// images: Array<{ type: string, data: string }>
```

### addConversationEntry èª¿ç”¨ç¯„ä¾‹

```javascript
// æç¤ºè©æ¢ç›®å¸¶åœ–ç‰‡
addConversationEntry(ConversationEntryType.PROMPT, fullPrompt, {
  title: `æç¤ºè© (${modeLabel})`,
  collapsed: false,
  timestamp: Date.now(),
  images: currentImages  // æ–°å¢
});
```

## Testing Considerations

1. **å–®å…ƒæ¸¬è©¦**
   - `renderEntryImages()` å‡½æ•¸è¼¸å‡ºé©—è­‰
   - Lightbox é–‹é—œç‹€æ…‹æ¸¬è©¦
   - éµç›¤äº‹ä»¶è™•ç†æ¸¬è©¦

2. **æ•´åˆæ¸¬è©¦**
   - æäº¤å¸¶åœ–ç‰‡å›é¥‹å¾Œå°è©±æ¢ç›®é¡¯ç¤º
   - å¤šåœ–ç‰‡ Lightbox ç€è¦½
   - éŸ¿æ‡‰å¼ä½ˆå±€æ¸¬è©¦

3. **E2E æ¸¬è©¦**
   - å®Œæ•´çš„åœ–ç‰‡ä¸Šå‚³ â†’ é¡¯ç¤º â†’ é è¦½æµç¨‹
