# Design: prepare-npm-release

## 架構概述

本變更涉及多個系統層面的協調修改，需要確保版本資訊在整個應用程式中保持一致。

```
┌─────────────────────────────────────────────────────────────┐
│                    Version Source of Truth                   │
│                      package.json.version                    │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
            ┌───────────────┐   ┌───────────────┐
            │   Backend     │   │   Frontend    │
            │  (index.ts)   │   │  (app.js)     │
            └───────┬───────┘   └───────┬───────┘
                    │                   │
        ┌───────────┼───────────┐       │
        │           │           │       │
        ▼           ▼           ▼       ▼
   cli.ts    mcp-server.ts  web-server.ts  index.html
                                 │           │
                                 └─────┬─────┘
                                       ▼
                                 /api/version
```

## 設計決策

### 1. 版本來源機制

**選項 A：編譯時注入（選擇此方案）**
- 在 `src/index.ts` 中使用 `fs.readFileSync` 讀取 `package.json`
- 優點：單一來源、無需額外構建步驟
- 缺點：需要處理路徑解析

**選項 B：環境變數注入**
- 在 `prepublishOnly` 腳本中設定 VERSION 環境變數
- 缺點：複雜且容易出錯

**選項 C：手動同步**
- 每次發行前手動更新多處版本號
- 缺點：容易遺漏、不可靠

### 2. 前端版本顯示

- 通過現有的 `/api/version` API 端點獲取版本
- 在頁面載入時動態插入版本號到頁首
- 位置：連接狀態指示器旁邊

### 3. 機密清理策略

- 將所有真實 API Key 替換為佔位符 `your-api-key-here`
- 保留 `logger.ts` 中的敏感資料過濾規則（這些是保護機制）
- 確保 `.npmignore` 排除 `.docs/` 目錄

## 風險與緩解

| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| 版本讀取失敗 | 高 | 提供硬編碼回退值 |
| 發行包含機密 | 高 | 發行前執行機密掃描腳本 |
| 路徑解析錯誤 | 中 | 使用 `import.meta.url` 解析相對路徑 |

## 相依性

- 無外部新增依賴
- 使用 Node.js 內建的 `fs` 和 `path` 模組
